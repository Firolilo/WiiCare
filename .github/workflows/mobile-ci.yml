name: Mobile CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'Movil/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'Movil/**'

jobs:
  # Job 1: Análisis estático y pruebas unitarias
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: Movil
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Analyze code
        run: flutter analyze

      - name: Run unit tests
        run: flutter test --coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./Movil/coverage/lcov.info
          flags: flutter

  # Job 2: Pruebas de integración
  integration_test:
    name: Integration Tests
    runs-on: macos-latest
    defaults:
      run:
        working-directory: Movil
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Start iOS Simulator
        uses: futureware-tech/simulator-action@v2
        with:
          model: 'iPhone 14'

      - name: Run integration tests
        run: flutter test integration_test/app_test.dart

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: integration-test-results
          path: Movil/test-results/

  # Job 3: Build Android
  build_android:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: [test]
    defaults:
      run:
        working-directory: Movil
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Build APK
        run: flutter build apk --release

      - name: Upload APK
        uses: actions/upload-artifact@v3
        with:
          name: wiicare-android-apk
          path: Movil/build/app/outputs/flutter-apk/app-release.apk

  # Job 4: Build iOS
  build_ios:
    name: Build iOS App
    runs-on: macos-latest
    needs: [test]
    defaults:
      run:
        working-directory: Movil
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Build iOS (no codesign)
        run: flutter build ios --release --no-codesign

      - name: Upload iOS build
        uses: actions/upload-artifact@v3
        with:
          name: wiicare-ios-build
          path: Movil/build/ios/iphoneos/

  # Job 5: Flutter Driver Tests (E2E)
  driver_test:
    name: Flutter Driver Tests
    runs-on: macos-latest
    defaults:
      run:
        working-directory: Movil
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Start iOS Simulator
        uses: futureware-tech/simulator-action@v2
        with:
          model: 'iPhone 14'

      - name: Run Flutter Driver tests
        run: flutter drive --target=test_driver/app.dart
        continue-on-error: true

      - name: Upload driver test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: driver-test-results
          path: Movil/test_driver/screenshots/
